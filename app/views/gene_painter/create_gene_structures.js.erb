hide_show_waiting('hide');

<% @new_genes.each do |gene| %>
  <% basename = gene.split('.').first%>

  // Count number of checks in view column first,
  // should be less than 20
  var count = _.filter($('input#view'), function(item) {
    return $(item).is(':checked');
  }).length;

  if (count < 20) {
    $(_.filter($('input#view'), function(item) {
      return $(item).attr('data') == '<%= basename %>';
    })[0]).removeAttr('disabled').prop('checked', true);
  }

  // Update gene status
  $('span#<%= basename %>').text('complete').css('color', 'green').css('font-weight', 'bold');
  $('span#<%= basename %>').parent().next().html('');
<% end %>

<% std_path = "#{Rails.root}/public/tmp/#{controller.id}-std.txt" %>
<% intron_phase_path = "#{Rails.root}/public/tmp/#{controller.id}-intron-phase.txt" %>

<% if FileTest.exists?(std_path) %>

  $('div#text-based').html('');
  $('div#text-based').append('<%= generate_text_based_output(std_path).html_safe %>');

  var colors = intronCountsToColors();
  colorLastRow(colors);

  var $textBasedTable = $('div#text-based');

  $('input#show_intron_phase').change(function() {
    var showOrNot = $(this).is(':checked');

    if (showOrNot) {
      $textBasedTable.html('<%= generate_text_based_output(intron_phase_path).html_safe %>');
    } else {
      $textBasedTable.html('<%= generate_text_based_output(std_path).html_safe %>');
    }

    colorLastRow(colors);
  });

  // Populate graphical tab
  <% convert_svg_to_pngs %>
  $('img#placeholder').prop('src', '<%= "/tmp/#{controller.id}-selected-normal.png" %>?timestamp=' + new Date().getTime());
  $('div#svg-merged').html('<%= render_svg("#{controller.id}-normal-merged.svg").delete!("\n").html_safe %>');

  $('input#standard').change(function() {
    var checkedOrNot = $(this).is(':checked');

    if (checkedOrNot) {
      $('img#placeholder').prop('src', '<%= "/tmp/#{controller.id}-selected-normal.png" %>?timestamp=' + new Date().getTime());
      $('div#svg-merged').html('<%= render_svg("#{controller.id}-normal-merged.svg").delete!("\n").html_safe %>');

      $('input#focus_on_common_introns').prop('disabled', true);
    } else {
      $('input#focus_on_common_introns').removeAttr('disabled');
    }
  });

  $('input#focus_on_common_introns').change(function() {
    var checkedOrNot = $(this).is(':checked');

    if (checkedOrNot) {
      $('img#placeholder').prop('src', '<%= "/tmp/#{controller.id}-selected-reduced.png" %>?timestamp=' + new Date().getTime());
      $('div#svg-merged').html('<%= render_svg("#{controller.id}-reduced-merged.svg").delete!("\n").html_safe %>');

      $('input#standard').prop('disabled', true);
    } else {
      $('input#standard').removeAttr('disabled');
    }
  });

  if (_.filter($('input#view'), function(item) {
    return ! $(item).is(':disabled');
  }).length > 20) {
    $('div#select_genes').css('display', 'inline');
    $('div#placeholder').html('<%= populate_select_genes_modal.html_safe %>');
  }

  

  $('div#b_aligned_gene_structures').toggle('slow');

<% end %>
