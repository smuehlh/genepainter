hide_show_waiting('hide');

<% @new_genes.each do |gene| %>
  <% basename = gene.split('.').first%>

  // Count number of checks in view column first,
  // should be less than 20
  var count = _.filter($('input#view'), function(item) {
    return $(item).is(':checked');
  }).length;

  if (count < 20) {
    $(_.filter($('input#view'), function(item) {
      return $(item).attr('data') == '<%= basename %>';
    })[0]).removeAttr('disabled').prop('checked', true);
  }

  // Update gene status
  $('span#<%= basename %>').text('complete').css('color', 'green').css('font-weight', 'bold');
  $('span#<%= basename %>').parent().next().html('');
<% end %>

<% std_path = "#{Rails.root}/public/tmp/#{controller.id}-std.txt" %>
<% intron_phase_path = "#{Rails.root}/public/tmp/#{controller.id}-intron-phase.txt" %>

<% if FileTest.exists?(std_path) %>

  $('div#text-based').html('');
  $('div#text-based').append('<%= generate_text_based_output(std_path).html_safe %>');

  var colors = intronCountsToColors();
  colorLastRow(colors);

  var $textBasedTable = $('div#text-based');

  $('input#show_intron_phase').change(function() {
    var showOrNot = $(this).is(':checked');

    if (showOrNot) {
      $textBasedTable.html('<%= generate_text_based_output(intron_phase_path).html_safe %>');
    } else {
      $textBasedTable.html('<%= generate_text_based_output(std_path).html_safe %>');
    }

    colorLastRow(colors);
  });

  // Set up table's cells with classnames
  var allCells = $('table#text_based_output').find('td');
  var rows = $('table#text_based_output').find('tr').length;
  var cols = allCells.length / rows;
  for(var x = 1; x < cols; x++){
    for (var y = 0; y < rows-1; y++) {
      if(allCells[cols*y + x].innerText != '-') {
        for (var z = 0; z < rows-1; z++) {
          $(allCells[cols*z + x]).addClass('intron-col-' + (x/2 - 1));
        }

        break;
      };
    }
  }

  // Populate graphical tab
  <% convert_svg_to_pngs %>
  $('img#placeholder').prop('src', '<%= "/tmp/#{controller.id}-selected-normal.png" %>?timestamp=' + new Date().getTime());
  $('div#svg-merged').html('<%= render_svg("#{controller.id}-normal-merged.svg").delete!("\n").html_safe %>');

  $('input#standard').change(function() {
    var checkedOrNot = $(this).is(':checked');

    if (checkedOrNot) {
      $('img#placeholder').prop('src', '<%= "/tmp/#{controller.id}-selected-normal.png" %>?timestamp=' + new Date().getTime());
      $('div#svg-merged').html('<%= render_svg("#{controller.id}-normal-merged.svg").delete!("\n").html_safe %>');

      $('input#focus_on_common_introns').prop('checked', false);
    }
  });

  $('input#focus_on_common_introns').change(function() {
    var checkedOrNot = $(this).is(':checked');

    if (checkedOrNot) {
      $('img#placeholder').prop('src', '<%= "/tmp/#{controller.id}-selected-reduced.png" %>?timestamp=' + new Date().getTime());
      $('div#svg-merged').html('<%= render_svg("#{controller.id}-reduced-merged.svg").delete!("\n").html_safe %>');

      $('input#standard').prop('checked', false);
    }
  });

  if (_.filter($('input#view'), function(item) {
    return ! $(item).is(':disabled');
  }).length > 20) {
    $('div#select_genes').css('display', 'inline');
    $('div#placeholder').html('<%= populate_select_genes_modal.html_safe %>');
  }

  $('div#b_aligned_gene_structures').toggle('slow');
  $('p#t_aligned_gene_structures').toggle('slow');

  <% if File.exist?("#{Rails.root}/public/tmp/#{controller.id}-taxonomy-intron-numbers.txt") %>

    // Display phylotree
    $('p#t_phylotree').toggle('slow');
    $('div#b_phylotree').toggle('slow');

    $('div#svg_placeholder').html('<%= render_svg("#{controller.id}-tree.svg").delete!("\n").html_safe %>');

    var intron_numbers = $('<div/>').html('<%= intron_numbers %>').text();
    var obj = JSON.parse(intron_numbers.replace(/=>/g, ':'));

    function colorize(cells) {
      _.each(cells, function(cell) {
        $(cell).addClass('highlighted');
      });
    }

    function resetTable() {
      $('.highlighted').removeClass('highlighted');
    }

    function resetPhylotree() {
      $('.taxon').removeAttr('fill');
      $('.taxon').removeAttr('style');
    }


    $('.taxon').click(function() {

      resetPhylotree();
      resetTable();

      this.setAttribute('fill', 'blue');
      this.setAttribute('style', 'font-size: 14px; font-weight: bold');

      var textTokens = this.innerHTML.split(" ");

      if (textTokens.length > 1) {
        textTokens.pop();
        textTokens.pop();
        textTokens.pop();
      }

      var nodeName = textTokens.toString().replace(/,/g, " ");

      _.each(obj[nodeName], function(element) {
        colorize($("." + element));
      });



    });
  <% end %>

<% end %>
