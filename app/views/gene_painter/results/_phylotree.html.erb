<% if File.exist?("#{Rails.root}/public/tmp/#{controller.id}-taxonomy-intron-numbers.txt") &&
      File.exist?("#{Rails.root}/public/tmp/#{controller.id}-tree.svg") then %>

  <%= render :partial => "gene_painter/help/phylotree_info" %>
  <%=
    content_tag(:div, "", 
      :id => "svg_placeholder", 
      :style => "padding: 10px 0px 10px 0px"
    ) +
    content_tag(:h4, "Legend") +
    content_tag(:div, render_tree_legend) +
    content_tag(:p, 
      "Click on taxa to highlight common/unique introns in text-based and graphical representation.", :class => "filename"
    )
  %>    

  <script>
      // Display phylotree
      $('div#svg_placeholder').html('<%= render_svg("#{controller.id}-tree.svg", "svg").html_safe %>');
      // add tooltip (title) to taxon-elements
      $(".taxon").attr("title", "Highlight introns in text-based and graphical representation.");

      var intron_numbers = $('<div/>').html('<%= intron_numbers %>').text();
      var obj = JSON.parse(intron_numbers.replace(/=>/g, ':'));

      function colorize(cells) {
        _.each(cells, function(cell) {
          $(cell).addClass('highlighted');
        });
      }

      function resetPhylotree() {
        // apparently, jquery-ui broke removeClass, so use this instead
        $(".taxon-highlight").attr("class", "taxon")
      }

      $('.taxon').click(function() {
        $("#phylo_tree_info").show(); // show info box
        resetPhylotree();
        resetTable();

        this.setAttribute('class', 'taxon taxon-highlight'); // taxon-highlight CSS for styling 

        var textTokens = this.innerHTML.split(" ");

        if (textTokens.length > 1) {
          textTokens.pop();
          textTokens.pop();
          textTokens.pop();
        }

        var nodeName = textTokens.toString().replace(/,/g, " ");
        var tmp = [];

        _.each(obj[nodeName], function(element) {
          colorize($("." + element));

          tmp.push(_.last(element.split("-")));
        });

        $('#genestructures-merged rect').removeClassSVG('fill-grey');

        if (tmp.length) {

          $('#genestructures-merged .background').addClassSVG('fill-grey');

          _.each($("#genestructures-merged rect"), function(rect) {

            if (!_.contains(tmp, rect.getAttribute('class').trim().split('_')[1])) {
              $(rect).addClassSVG('fill-grey');
            }
          });
        }

      });
  </script>

<% else %>
	<%= content_tag(:i, 
		"Cannot display phylogenetic tree."
	)%>
<% end %>